trigger: none

parameters:
- name: example
  displayName: Terraform Example
  type: string
  values:
  - 001_resource_group
  - 002_vnet
  - 003_storage_account

stages:
- stage: Terraform

  pool:
    vmImage: ubuntu-latest

  jobs:
  - job: BuildInfra
    steps:
    - task: azurekeyVault@2
      displayName: Retrieve secrets
      inputs:
        connectedServiceName: Azure
        keyVaultName: azdokv-nDkVq
        secretsFilter: tf-token
        runAsPreJob: true

    - task: terraformInstaller@0
      displayName: Terraform Install
      inputs:
        terraformVersion: 'latest'

    - task: replaceTokens@5
      displayName: Update token files
      inputs:
        targetFiles: $(System.DefaultWorkingDirectory)/pipelines/tfToken.json
        tokenPattern: 'azpipelines'

    - bash: |
        cat $(System.DefaultWorkingDirectory)/pipelines/tfToken.json
        cd $(System.DefaultWorkingDirectory)/azure/${{ parameters.example }}/
        mv $(System.DefaultWorkingDirectory)/pipelines/tfToken.json /home/vsts/.terraform.d/credentials.tfrc.json
      displayName: Terraform Login

    - task: terraformCLI@0
      displayName: Terraform Init
      inputs:
        command: init
        workingDirectory: $(System.DefaultWorkingDirectory)/azure/${{ parameters.example }}/
